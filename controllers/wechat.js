// Generated by CoffeeScript 1.6.3
var EventProxy, checkSignature, config, crypto, getParse, qs, url, xml2js;

crypto = require('crypto');

xml2js = require('xml2js');

url = require('url');

qs = require('querystring');

EventProxy = require('eventproxy');

config = require('../config').config;

checkSignature = function(query, token) {
  var arr, nonce, shasum, signature, timestamp;
  signature = query.signature;
  timestamp = query.timestamp;
  nonce = query.nonce;
  shasum = crypto.createHash('sha1');
  arr = [token, timestamp, nonce].sort();
  shasum.update(arr.join(''));
  return shasum.digest('hex') === signature;
};

getParse = function(req) {
  var query;
  query = url.parse(req.url).query;
  return qs.parse(query);
};

exports.index = function(req, res, next) {
  var parse, to;
  parse = getParse(req);
  console.log(req);
  to = checkSignature(parse, config.wechat_token);
  return res.send(to ? parse.echostr : "false");
};
