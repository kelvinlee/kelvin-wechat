var CheckUsers,access_token,checkMenus,checkToken,getToken,getUserInfo,getUsers,https,options_create_menu,options_custom,options_get_access_token,options_get_menu,options_send,options_user_info,options_users,post_data,querystring,sendMenus,url;https=require("https"),url=require("url"),querystring=require("querystring"),access_token={},options_create_menu={host:"https://api.weixin.qq.com/cgi-bin/menu/create?access_token=",method:"POST"},options_get_menu={host:"https://api.weixin.qq.com/cgi-bin/menu/get?access_token=",method:"GET"},options_get_access_token={host:"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=wx86b8da13792d7a54&secret=f93ec247a40c59eccbf4bc8b5ac5721c",method:"GET"},options_custom={host:"https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=",method:"POST"},options_send={host:"https://api.weixin.qq.com/cgi-bin/message/send?access_token=",method:"POST"},options_users={host:"https://api.weixin.qq.com/cgi-bin/user/get?access_token=",method:"GET"},options_user_info={host:"https://api.weixin.qq.com/cgi-bin/user/info?lang=zh_CN&access_token=",method:"GET"},post_data={button:[{type:"click",name:"桥哥",key:"myself"},{name:"新奇世界",sub_button:[{type:"click",name:"新奇产品",key:"product"},{type:"click",name:"新奇事件",key:"things"},{type:"click",name:"新奇人物",key:"people"}]},{type:"click",name:"跟桥哥对话",key:"talkto"}]},checkToken=function(e){return access_token.date&&access_token.date>(new Date).getTime()?(e(!1),!0):(getToken(e),!1)},getToken=function(e){var t;return t=https.get(options_get_access_token.host,function(t){return console.log("STATUS: "+t.statusCode),console.log("HEADERS: "+JSON.stringify(t.headers)),t.setEncoding("utf8"),t.on("data",function(t){var n;return console.log("BODY: "+t),n=JSON.parse(t),n.access_token?(access_token=n,access_token.date=(new Date).getTime()+1e3*n.expires_in,e(!1)):e("There is no token")})}),t.write("\n"),t.end()},sendMenus=function(){var e,t,n,o;return o=url.parse(options_create_menu.host),t=o.port?o.port:80,e={hostname:o.host,port:443,path:o.path+access_token.access_token,method:"POST"},console.log(e,t),n=https.request(e,function(e){return console.log("statusCode: ",e.statusCode),console.log("headers: ",e.headers),e.on("data",function(e){var t;return t=JSON.parse(e),console.log(t)})}),console.log(JSON.stringify(post_data)),n.write(JSON.stringify(post_data)+"\n"),n.end()},checkMenus=function(){var e;return e=https.get(options_get_menu.host+access_token.access_token,function(e){return console.log("statusCode: ",e.statusCode),console.log("headers: ",e.headers),e.on("data",function(e){var t;return t=JSON.parse(e),console.log(t)})}),e.write("\n"),e.end()},getUsers=function(e){var t;return"start"===e||e?(t=https.get(options_users.host+access_token.access_token,function(e){return e.on("data",function(e){var t;return t=JSON.parse(e),console.log(t),CheckUsers(t)})}),t.write("\n"),t.end()):void 0},CheckUsers=function(e){return e.next_openid?getUsers(e.next_openid):void 0},getUserInfo=function(e){var t;return t=https.get(options_user_info.host+access_token.access_token+"&openid="+e,function(e){return console.log("statusCode: ",e.statusCode),console.log("headers: ",e.headers),e.on("data",function(e){var t;return t=JSON.parse(e),console.log(t)})}),t.write("\n"),t.end()},exports.gettoken=function(e,t,n){return checkMenus(),t.render("wechat-ctrl")},exports.getmenu=function(e,t,n){return console.log((new Date).getTime(),access_token.date),checkToken(function(e){return e?!1:(sendMenus(),t.render("wechat-ctrl"))})};