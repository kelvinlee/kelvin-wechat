// Generated by CoffeeScript 1.6.3
var checkUpload, copyform, k, r, showupload, startupload;

$(document).ready(function() {
  $("#datatable").dataTable({
    "bLengthChange": false,
    "aaSorting": [[3, 'desc']],
    "oLanguage": {
      "sInfo": "从 _START_ 到 _END_ 条,共 _TOTAL_ 条"
    }
  });
  $('.dataTables_filter input').addClass('form-control').attr('placeholder', 'Search');
  $('.dataTables_length select').addClass('form-control');
  $('.pull-left:first').html('<a href="javascript:void(0)" onclick="showupload()" class="btn btn-primary">添加文件</a>');
  $('[name=upload]').click(function() {
    return startupload();
  });
  return $('[name=addnew]').on("click", function() {
    return copyform($(this));
  });
});

copyform = function(o) {
  var parent;
  parent = o.parents('form:first');
  parent = parent.clone();
  parent.find('.has-error').removeClass('has-error');
  parent.find('.error').html('');
  parent.find('.fa-plus').removeClass('fa-plus').addClass('fa-minus');
  parent.find('[name=addnew]').on('click', function() {
    return parent.remove();
  });
  return $('[name=notethis]').before(parent);
};

k = 1;

r = true;

checkUpload = function(su) {
  var n;
  n = $('[name=upfiles]').length;
  if (su === false) {
    r = false;
  }
  console.log(n, k);
  if (k >= n) {
    console.log(r);
    if (r) {
      window.location.reload();
    }
    return;
  }
  return k++;
};

startupload = function() {
  return $('[name=upfiles]').each(function(i) {
    var $ep;
    console.log($(this).attr('action'));
    console.log($(this).find("[name=userfile]").attr('id'));
    $ep = $(this);
    return $.ajaxFileUpload({
      url: $(this).attr('action'),
      secureuri: false,
      fileElementId: $(this).find("[type=file]"),
      dataType: 'json',
      data: {
        name: 'logan',
        id: 'id'
      },
      success: function(data, status) {
        console.log(data, typeof data.error);
        if (typeof data.error !== 'undefined') {
          console.log('error');
          checkUpload(false);
          $('.form-group', $ep).addClass('has-error');
          $('.error', $ep).html(data.error);
          return;
        }
        if (i !== 0) {
          $('[name=addnew]', $ep).click();
        }
        return checkUpload(true);
      }
    });
  });
};

showupload = function() {
  return $('#uploadfile').modal('show');
};
